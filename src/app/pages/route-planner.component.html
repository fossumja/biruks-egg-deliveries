<div class="page-header" [class.searching]="showSearch">
  <div class="header-actions">
    <select
      class="form-control route-select"
      [(ngModel)]="selectedRouteOrRun"
      (ngModelChange)="onRouteOrRunChange($event)"
    >
      <option [ngValue]="null" disabled>Choose a route‚Ä¶</option>
      <optgroup label="Routes">
        <option [ngValue]="ALL_SCHEDULES">
          All Schedules ({{ allSchedulesTotal }})
        </option>
        <option *ngFor="let r of routes" [ngValue]="'route:' + r.routeDate">
          {{ r.routeDate }} ({{ r.totalStops }} stops)
        </option>
      </optgroup>
      <optgroup *ngIf="allRuns.length" label="Past runs">
        <option [ngValue]="'receipts:all'">
          All receipts
        </option>
        <option *ngFor="let run of allRuns" [ngValue]="'run:' + run.id">
          {{ run.routeDate }} ‚Äî {{ run.date | date : 'shortDate' }}
          <span *ngIf="run.status === 'endedEarly'"> (ended early)</span>
        </option>
      </optgroup>
    </select>
    <button
      class="btn btn-secondary icon-btn btn-reorder"
      type="button"
      (click)="toggleReorder()"
      [class.active]="reorderEnabled"
      [attr.aria-pressed]="reorderEnabled"
      [attr.aria-label]="reorderEnabled ? 'Disable reordering' : 'Enable reordering'"
      [title]="reorderEnabled ? 'Disable reordering' : 'Enable reordering'"
    >
      <span class="glyph">‚áÖ</span>
    </button>
    <button
      class="btn btn-secondary icon-btn btn-add"
      type="button"
      (click)="openNewDeliveryForm()"
      aria-label="Add delivery"
      title="Add delivery"
    >
      <span class="glyph">+</span>
    </button>
    <button
      class="btn btn-secondary icon-btn btn-search"
      type="button"
      (click)="toggleSearch()"
      aria-label="Search deliveries"
      title="Search deliveries"
    >
      <span class="glyph">üîç</span>
    </button>
  </div>
  <div class="search-row" *ngIf="showSearch">
    <input
      class="form-control search-input"
      type="search"
      placeholder="Search deliveries‚Ä¶"
      [(ngModel)]="searchTerm"
      (ngModelChange)="applyFilter()"
    />
    <button
      class="btn btn-secondary icon-btn"
      type="button"
      (click)="searchTerm=''; applyFilter(false); toggleSearch()"
      aria-label="Close search"
      title="Close search"
    >
      √ó
    </button>
  </div>
</div>

<div *ngIf="loading" class="status text-muted">Loading‚Ä¶</div>
<div *ngIf="errorMessage" class="status error">{{ errorMessage }}</div>

<div class="card new-delivery-card" *ngIf="showNewForm">
  <div class="new-header">
    <h3 class="section-title">Add delivery</h3>
  </div>

  <form class="new-form" (submit)="$event.preventDefault()">
    <label>
      Schedule
      <select
        class="form-control"
        [(ngModel)]="newDelivery.routeDate"
        name="newRouteDate"
      >
        <option *ngFor="let r of routes" [ngValue]="r.routeDate">
          {{ r.routeDate }}
        </option>
      </select>
    </label>
    <label>
      Name
      <input class="form-control" [(ngModel)]="newDelivery.name" name="newName" />
    </label>
    <label>
      Address
      <input class="form-control" [(ngModel)]="newDelivery.address" name="newAddress" />
    </label>
    <label>
      City
      <input class="form-control" [(ngModel)]="newDelivery.city" name="newCity" />
    </label>
    <label>
      State
      <input class="form-control" [(ngModel)]="newDelivery.state" name="newState" />
    </label>
    <label>
      ZIP
      <input class="form-control" [(ngModel)]="newDelivery.zip" name="newZip" />
    </label>
    <label>
      Order in route
      <input
        class="form-control"
        type="number"
        min="1"
        [max]="deliveries.length + 1"
        [(ngModel)]="newDelivery.deliveryOrder"
        name="newOrder"
      />
    </label>
    <label>
      Dozen
      <input
        class="form-control"
        type="number"
        min="0"
        [(ngModel)]="newDelivery.dozens"
        name="newDozens"
        required
      />
    </label>
    <label class="full-width">
      Notes
      <textarea class="form-control" rows="2" [(ngModel)]="newDelivery.notes" name="newNotes"></textarea>
    </label>
    <div class="form-hint full-width" *ngIf="newDeliveryErrors.length">
      <div *ngFor="let err of newDeliveryErrors" class="error-text">{{ err }}</div>
    </div>
    <div class="form-hint full-width text-muted">
      Address fields can be left blank if unknown. You can reorder or edit later.
    </div>
  </form>
  <div class="donation-actions">
    <button class="btn btn-text" type="button" (click)="cancelNewDelivery()">Cancel</button>
    <button class="btn btn-primary" type="button" (click)="saveNewDelivery()" [disabled]="!canSaveNew || savingNew">
      {{ savingNew ? 'Saving‚Ä¶' : 'Save' }}
    </button>
  </div>
</div>

<div *ngIf="!loading && !errorMessage && deliveries.length && !viewingRun">
  <div
    cdkDropList
    [cdkDropListData]="filteredDeliveries"
    [cdkDropListDisabled]="(showSearch && searchTerm.trim()) || routeDate === ALL_SCHEDULES || !reorderEnabled"
    (cdkDropListDropped)="drop($event)"
    class="drop-list"
  >
    <div
      class="planner-swipe-row"
      *ngFor="let stop of filteredDeliveries; let i = index"
      cdkDrag
      [class.open]="openRowId === stop.id"
      [cdkDragDisabled]="isSwiping || !reorderEnabled"
      (cdkDragStarted)="handleDragStart()"
    >
      <div class="planner-swipe-actions">
        <div class="action-row">
          <button
            class="btn btn-text skip-btn"
            type="button"
            (click)="isUnsubscribed(stop) ? resubscribeStop(stop) : (isSkipped(stop) ? unskipStop(stop) : skipStop(stop))"
          >
            {{ isUnsubscribed(stop) ? 'Resubscribe' : (isSkipped(stop) ? 'Unskip' : 'Skip') }}
          </button>
          <button class="btn btn-text" type="button" (click)="openEdit(stop)">Edit</button>
          <button class="btn btn-text reset-warn" type="button" (click)="resetStop(stop)">Reset</button>
        </div>
        <div class="action-row">
          <button class="btn btn-secondary" type="button" (click)="openDonationDetails(stop)">Donation</button>
          <button class="btn btn-secondary" type="button" (click)="openOffScheduleDelivery(stop)">Delivery</button>
        </div>
      </div>

      <div class="route-item planner-row-content"
        [style.transform]="getRowTransform(stop)"
        (pointerdown)="startSwipe($event, stop)"
        (pointermove)="moveSwipe($event, stop)"
        (pointerup)="endSwipe($event, stop)"
        (click)="toggleRow(stop)">
        <ng-container *ngIf="reorderEnabled; else orderOnly">
          <div class="drag-handle" cdkDragHandle aria-label="Reorder stop">
            <span class="glyph">‚â°</span>
            <span class="order-number text-muted">
              {{ stop.deliveryOrder + 1 }}
            </span>
          </div>
        </ng-container>
        <ng-template #orderOnly>
          <div class="drag-handle order-only">
            <span class="order-number text-muted">
              {{ stop.deliveryOrder + 1 }}
            </span>
          </div>
        </ng-template>
        <div class="route-item-body">
          <div class="row-top">
            <div class="stop-name">{{ stop.name }}</div>
            <div class="stop-meta">
              <span
                class="status-pill"
                [class.pending]="!stop.status"
                [class.delivered]="stop.status === 'delivered'"
                [class.skipped]="stop.status === 'skipped'"
                [class.changed]="stop.status === 'changed'"
                [class.unsubscribed]="isUnsubscribed(stop)"
              >
                {{ isUnsubscribed(stop) ? 'Unsubscribed' : (stop.status ? (stop.status | titlecase) : 'Pending') }}
              </span>
            </div>
          </div>
          <div class="row-bottom">
            <div class="stop-address text-muted">
              {{ stop.address || '(no address)' }}
              <br />
              {{ stop.city }}<span *ngIf="stop.city && stop.state">,</span> {{ stop.state }} {{ stop.zip }}
            </div>
            <div class="stop-qty">
              <button type="button" class="qty-btn" (click)="adjustPlanned(stop, -1); $event.stopPropagation()">‚àí</button>
              <span class="qty-display" aria-label="Planned dozen">{{ stop.dozens }}</span>
              <button type="button" class="qty-btn" (click)="adjustPlanned(stop, 1); $event.stopPropagation()">+</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Inline edit card shown beneath the stop being edited -->
      <div class="edit-inline card" *ngIf="editingStop?.id === stop.id">
        <h3>Edit delivery</h3>
        <div class="new-form">
          <label>
            Schedule
            <select
              class="form-control"
              [(ngModel)]="editDraft.routeDate"
              name="editRouteDate"
            >
              <option *ngFor="let r of routes" [ngValue]="r.routeDate">
                {{ r.routeDate }}
              </option>
            </select>
          </label>
          <label>
            Name
            <input class="form-control" [(ngModel)]="editDraft.name" name="editName" />
          </label>
          <label>
            Address
            <input class="form-control" [(ngModel)]="editDraft.address" name="editAddress" />
          </label>
          <label>
            City
            <input class="form-control" [(ngModel)]="editDraft.city" name="editCity" />
          </label>
          <label>
            State
            <input class="form-control" [(ngModel)]="editDraft.state" name="editState" />
          </label>
          <label>
            ZIP
            <input class="form-control" [(ngModel)]="editDraft.zip" name="editZip" />
          </label>
          <label>
            Order in route
            <input
              class="form-control"
              type="number"
              min="1"
              [max]="deliveries.length"
              [(ngModel)]="editDraft.deliveryOrder"
              name="editOrder"
            />
          </label>
          <label>
            Dozen
            <input
              class="form-control"
              type="number"
              min="0"
              [(ngModel)]="editDraft.dozens"
              name="editDozens"
            />
          </label>
          <label class="full-width">
            Notes
            <textarea class="form-control" rows="2" [(ngModel)]="editDraft.notes" name="editNotes"></textarea>
          </label>
        </div>
        <div class="donation-actions">
          <div class="left-actions">
            <button
              *ngIf="editingStop && isUnsubscribed(editingStop)"
              class="btn btn-secondary"
              type="button"
              (click)="resubscribeStop(editingStop)"
            >
              Resubscribe
            </button>
            <button
              *ngIf="editingStop && !isUnsubscribed(editingStop)"
              class="btn btn-text warn"
              type="button"
              (click)="unsubscribeStop(editingStop)"
            >
              Unsubscribe
            </button>
          </div>
          <div class="right-actions">
            <button class="btn btn-text" type="button" (click)="cancelEdit()">Cancel</button>
            <button class="btn btn-primary" type="button" (click)="saveEdit()">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!loading && !errorMessage && viewingRun">
  <div
    class="planner-swipe-row"
    *ngFor="let entry of filteredRunEntries"
  >
    <div class="route-item run-history-card">
      <div class="drag-handle order-only">
        <span class="order-number text-muted" *ngIf="!viewingAllReceipts">
          {{ entry.deliveryOrder + 1 }}
        </span>
      </div>
      <div class="route-item-body">
        <div class="row-top">
          <div class="stop-name">
            {{ entry.name }}
          </div>
          <div class="stop-meta">
            <span
              class="status-pill"
              [class.delivered]="entry.status === 'delivered'"
              [class.skipped]="entry.status === 'skipped'"
              [class.donation]="entry.status === 'donation'"
            >
              {{ entry.status | titlecase }}
            </span>
          </div>
        </div>
        <div class="row-bottom">
          <div class="stop-address text-muted">
            <ng-container *ngIf="entry.eventDate; else noDate">
              {{ entry.eventDate | date : 'short' : undefined : 'en-US' }}
            </ng-container>
            <ng-template #noDate>
              (no date)
            </ng-template>
          </div>
          <div class="stop-qty">
            <span class="qty-display">{{ entry.dozens }}</span>
          </div>
        </div>
        <div class="donation-summary text-muted">
          <ng-container [ngSwitch]="entry.donationStatus">
            <span *ngSwitchCase="'NoDonation'">No donation</span>
            <span *ngSwitchCase="'NotRecorded'">Donation not recorded</span>
            <span *ngSwitchCase="'Donated'">
              {{ entry.donationMethod ? (entry.donationMethod | titlecase) : 'Donated' }}
              ${{ entry.donationAmount | number : '1.0-0' }}
            </span>
          </ng-container>
        </div>
        <div class="run-entry-actions">
          <button
            type="button"
            class="btn btn-text"
            (click)="openRunEntryEdit(entry)"
          >
            Edit
          </button>
        </div>
      </div>
    </div>

    <div class="edit-inline card" *ngIf="editingRunEntry?.id === entry.id && runEntryDraft">
      <h3>Edit run entry</h3>
      <div class="new-form">
        <label *ngIf="editingRunEntry?.runId !== 'oneoff'">
          Status
          <select
            class="form-control"
            [(ngModel)]="runEntryDraft.status"
            name="runEntryStatus"
          >
            <option value="delivered">Delivered</option>
            <option value="skipped">Skipped</option>
          </select>
        </label>
        <label *ngIf="editingRunEntry?.runId !== 'oneoff'">
          Order in route
          <input
            class="form-control"
            type="number"
            min="1"
            [max]="runEntries.length"
            [(ngModel)]="runEntryDraft.deliveryOrder"
            name="runEntryOrder"
          />
        </label>
        <label *ngIf="editingRunEntry?.runId !== 'oneoff' || editingRunEntry?.oneOffKind === 'delivery'">
          Dozen
          <input
            class="form-control"
            type="number"
            min="0"
            [(ngModel)]="runEntryDraft.dozens"
            name="runEntryDozens"
          />
        </label>
        <label
          *ngIf="
            editingRunEntry?.runId === 'oneoff' &&
            runEntryDraft.donationStatus === 'Donated'
          "
        >
          Suggested amount (baseline)
          <input
            class="form-control"
            type="number"
            min="0"
            [(ngModel)]="runEntryDraft.suggestedAmount"
            name="runEntrySuggested"
          />
        </label>
        <label>
          Donation status
          <select
            class="form-control"
            [(ngModel)]="runEntryDraft.donationStatus"
            name="runEntryDonationStatus"
          >
            <option value="NotRecorded">Not recorded</option>
            <option value="NoDonation">No donation</option>
            <option value="Donated">Donated</option>
          </select>
        </label>
        <label *ngIf="runEntryDraft.donationStatus === 'Donated'">
          Donation method
          <select
            class="form-control"
            [(ngModel)]="runEntryDraft.donationMethod"
            name="runEntryDonationMethod"
          >
            <option value="">(none)</option>
            <option value="cash">Cash</option>
            <option value="ach">Ach</option>
            <option value="venmo">Venmo</option>
            <option value="paypal">Paypal</option>
            <option value="other">Other</option>
          </select>
        </label>
        <label *ngIf="runEntryDraft.donationStatus === 'Donated'">
          Donation amount
          <input
            class="form-control"
            type="number"
            min="0"
            [(ngModel)]="runEntryDraft.donationAmount"
            name="runEntryDonationAmount"
          />
        </label>
      </div>
      <div class="donation-actions">
        <button
          class="btn btn-text"
          type="button"
          (click)="cancelRunEntryEdit()"
        >
          Cancel
        </button>
        <button
          class="btn btn-primary"
          type="button"
          (click)="saveRunEntryEdit()"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>
<div
  class="status text-muted card"
  *ngIf="!loading && !errorMessage && !viewingRun && !deliveries.length"
>
  No deliveries found for this route.
</div>

<div class="donation-overlay" *ngIf="donationModalStop">
  <div class="donation-dialog">
    <h3>Donation for {{ donationModalStop!.name }}</h3>
    <div class="card">
      <app-donation-controls
        [donation]="donationDraft?.donation || null"
        [suggestedAmount]="donationDraft?.donation?.suggestedAmount || donationModalStop.dozens * getSuggestedRate()"
        [showNoDonation]="true"
        [allowReselect]="true"
        [showQty]="true"
        [qtyValue]="donationDraft?.dozens ?? donationModalStop.dozens"
        (qtyChange)="onDonationQtyChange($event)"
        (donationStatusChange)="setDonationStatus($event)"
        (donationMethodChange)="setDonationMethod($event)"
        (amountChange)="onDonationAmountChange($event)"
      />
    </div>
    <div class="card totals-card">
      <div class="totals-row">
        <span>Total Donations</span>
        <span>${{ donationTotals.donationTotal | number : '1.0-0' }}</span>
      </div>
      <div class="totals-row">
        <span>Total Dozen</span>
        <span>{{ donationTotals.dozensTotal }}</span>
      </div>
      <div class="totals-row">
        <span>Deductible charitable contribution</span>
        <span>${{ donationTotals.taxableTotal | number : '1.0-0' }}</span>
      </div>
    </div>
    <div class="donation-actions">
      <button type="button" class="ghost" (click)="closeDonationModal()">Cancel</button>
      <button type="button" class="btn btn-primary" (click)="saveDonation()">Save</button>
    </div>
  </div>
</div>

<div class="donation-overlay" *ngIf="offScheduleStop">
  <div class="donation-dialog">
    <h3>Delivery for {{ offScheduleStop!.name }}</h3>
    <div class="delivery-card card">
      <app-stop-delivery-card
        [stop]="offScheduleStop"
        [deliveredQty]="offDeliveredQty"
        [donation]="offDonationDraft"
        [suggestedAmount]="offDonationDraft?.suggestedAmount ?? offDeliveredQty * 4"
        [showNoDonation]="true"
        [allowDonationReselect]="false"
        [showNotes]="false"
        (adjustQty)="adjustOffDelivered($event)"
        (donationStatusChange)="setOffDonationStatus($event)"
        (donationMethodChange)="setOffDonationMethod($event)"
        (amountChange)="onOffAmountChange($event)"
        (copyAddress)="copyAddress(offScheduleStop)"
        (openMap)="openMaps(offScheduleStop)"
      />
    </div>
    <div class="donation-actions">
      <button type="button" class="ghost" (click)="closeOffSchedule()">Cancel</button>
      <button type="button" class="btn btn-primary" (click)="saveOffSchedule()">Save</button>
    </div>
  </div>
</div>

<div class="amount-overlay" *ngIf="showAmountPicker">
  <app-donation-amount-picker
    [currentAmount]="selectedAmount"
    [suggestedAmount]="donationDraft?.donation?.suggestedAmount ?? 0"
    (cancel)="closeAmountPicker()"
    (save)="confirmAmountFromPicker($event)"
  />
</div>
