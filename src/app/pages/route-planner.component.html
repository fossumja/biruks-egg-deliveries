<div class="page-header" [class.searching]="showSearch">
  <div class="header-actions">
    <select
      class="form-control route-select"
      [(ngModel)]="selectedRouteOrRun"
      (ngModelChange)="onRouteOrRunChange($event)"
    >
      <option [ngValue]="null" disabled>Choose a route‚Ä¶</option>
      <optgroup label="Routes">
        <option [ngValue]="ALL_SCHEDULES">
          All Schedules ({{ allSchedulesTotal }})
        </option>
        <option *ngFor="let r of routes" [ngValue]="'route:' + r.routeDate">
          {{ r.routeDate }} ({{ r.totalStops }} stops)
        </option>
      </optgroup>
      <optgroup *ngIf="allRuns.length" label="Past runs">
        <option [ngValue]="'receipts:all'">
          All receipts ({{ selectedTaxYearLabel }})
        </option>
        <option *ngFor="let run of allRuns" [ngValue]="'run:' + run.id">
          {{ run.routeDate }} ‚Äî {{ run.date | date : 'shortDate' }}
          <span *ngIf="run.status === 'endedEarly'"> (ended early)</span>
        </option>
      </optgroup>
    </select>
    <button
      *ngIf="!viewingRun"
      class="btn btn-secondary icon-btn btn-reorder"
      type="button"
      (click)="toggleReorder()"
      [class.active]="reorderEnabled"
      [attr.aria-pressed]="reorderEnabled"
      [attr.aria-label]="reorderEnabled ? 'Disable reordering' : 'Enable reordering'"
      [title]="reorderEnabled ? 'Disable reordering' : 'Enable reordering'"
    >
      <span class="glyph">‚áÖ</span>
    </button>
    <button
      *ngIf="!viewingRun"
      class="btn btn-secondary icon-btn btn-add"
      type="button"
      (click)="openNewDeliveryForm()"
      aria-label="Add delivery"
      title="Add delivery"
    >
      <span class="glyph">+</span>
    </button>
    <button
      class="btn btn-secondary icon-btn btn-search"
      type="button"
      (click)="toggleSearch()"
      aria-label="Search deliveries"
      title="Search deliveries"
    >
      <span class="glyph">üîç</span>
    </button>
  </div>
  <div class="search-row" *ngIf="showSearch">
    <input
      class="form-control search-input"
      type="search"
      placeholder="Search deliveries‚Ä¶"
      [(ngModel)]="searchTerm"
      (ngModelChange)="applyFilter()"
    />
    <button
      class="btn btn-secondary icon-btn"
      type="button"
      (click)="searchTerm=''; applyFilter(false); toggleSearch()"
      aria-label="Close search"
      title="Close search"
    >
      √ó
    </button>
  </div>
</div>

<ng-template #receiptHistoryList>
  <div class="receipt-history">
    <div class="receipt-history-divider" aria-hidden="true"></div>
    <div class="receipt-history-header">
      Previous receipts ¬∑ Tax year {{ selectedTaxYearLabel }}
    </div>
    @if (receiptHistoryLoading) {
      <div class="receipt-history-empty text-muted">Loading receipts...</div>
    } @else {
      @if (receiptHistory.length) {
        <ul class="receipt-history-list" role="list">
          @for (entry of receiptHistory; track $index) {
            <li class="receipt-history-item">
              <div class="receipt-history-details">
                <span class="receipt-history-date">
                  @if (entry.date) {
                    {{ entry.date | date : 'shortDate' : undefined : 'en-US' }}
                  } @else {
                    <span class="receipt-history-date-missing">No date</span>
                  }
                </span>
                <span class="receipt-history-sep" aria-hidden="true">‚Ä¢</span>
                <span
                  class="receipt-history-status"
                  [class.is-delivered]="entry.status === 'delivered'"
                  [class.is-skipped]="entry.status === 'skipped'"
                  [class.is-donation]="entry.status === 'donation'"
                >
                  {{ formatReceiptStatus(entry.status) }}
                </span>
                @if (entry.status === 'delivered') {
                  <span class="receipt-history-sep" aria-hidden="true">‚Ä¢</span>
                  <span class="receipt-history-dozens">
                    {{ formatReceiptDozens(entry) }}
                  </span>
                }
                @if (entry.donationStatus === 'Donated') {
                  <span class="receipt-history-sep" aria-hidden="true">‚Ä¢</span>
                  <span class="receipt-history-donation">
                    {{ formatReceiptDonationMethod(entry.donationMethod) }}
                    ${{ entry.donationAmount | number : '1.2-2' }}
                  </span>
                }
              </div>
              @if (canDeleteReceiptHistoryEntry(entry)) {
                <div class="receipt-history-action">
                  <button
                    type="button"
                    class="btn btn-text warn receipt-delete-btn"
                    (click)="confirmDeleteReceiptHistory(entry)"
                    [attr.aria-label]="getReceiptHistoryDeleteLabel(entry)"
                  >
                    Delete
                  </button>
                </div>
              }
            </li>
          }
        </ul>
      } @else {
        <div class="receipt-history-empty text-muted">No previous receipts yet.</div>
      }
    }
  </div>
</ng-template>

<div *ngIf="loading" class="status text-muted">Loading‚Ä¶</div>
<div *ngIf="errorMessage" class="status error">{{ errorMessage }}</div>

<div class="card new-delivery-card" *ngIf="showNewForm">
  <div class="new-header">
    <h3 class="section-title">Add delivery</h3>
  </div>

  <form class="new-form" (submit)="$event.preventDefault()">
    <label>
      Schedule
      <select
        class="form-control"
        [(ngModel)]="newDelivery.routeDate"
        name="newRouteDate"
      >
        <option *ngFor="let r of routes" [ngValue]="r.routeDate">
          {{ r.routeDate }}
        </option>
      </select>
    </label>
    <label>
      Name
      <input class="form-control" [(ngModel)]="newDelivery.name" name="newName" />
    </label>
    <label>
      Address
      <input class="form-control" [(ngModel)]="newDelivery.address" name="newAddress" />
    </label>
    <label>
      City
      <input class="form-control" [(ngModel)]="newDelivery.city" name="newCity" />
    </label>
    <label>
      State
      <input class="form-control" [(ngModel)]="newDelivery.state" name="newState" />
    </label>
    <label>
      ZIP
      <input class="form-control" [(ngModel)]="newDelivery.zip" name="newZip" />
    </label>
    <label>
      Order in route
      <input
        class="form-control"
        type="number"
        min="1"
        [max]="deliveries.length + 1"
        [(ngModel)]="newDelivery.deliveryOrder"
        name="newOrder"
      />
    </label>
    <label>
      Dozen
      <input
        class="form-control"
        type="number"
        min="0"
        [(ngModel)]="newDelivery.dozens"
        name="newDozens"
        required
      />
    </label>
    <label class="full-width">
      Notes
      <textarea class="form-control" rows="2" [(ngModel)]="newDelivery.notes" name="newNotes"></textarea>
    </label>
    <div class="form-hint full-width" *ngIf="newDeliveryErrors.length">
      <div *ngFor="let err of newDeliveryErrors" class="error-text">{{ err }}</div>
    </div>
    <div class="form-hint full-width text-muted">
      Address fields can be left blank if unknown. You can reorder or edit later.
    </div>
  </form>
  <div class="donation-actions">
    <button class="btn btn-text" type="button" (click)="cancelNewDelivery()">Cancel</button>
    <button class="btn btn-primary" type="button" (click)="saveNewDelivery()" [disabled]="!canSaveNew || savingNew">
      {{ savingNew ? 'Saving‚Ä¶' : 'Save' }}
    </button>
  </div>
</div>

<div *ngIf="!loading && !errorMessage && deliveries.length && !viewingRun">
  <div
    cdkDropList
    [cdkDropListData]="filteredDeliveries"
    [cdkDropListDisabled]="(showSearch && searchTerm.trim()) || routeDate === ALL_SCHEDULES || !reorderEnabled"
    (cdkDropListDropped)="drop($event)"
    class="drop-list"
  >
    <div
      class="planner-swipe-row"
      *ngFor="let stop of filteredDeliveries; let i = index"
      cdkDrag
      [class.open]="openRowId === stop.id"
      [cdkDragDisabled]="isSwiping || !reorderEnabled"
      (cdkDragStarted)="handleDragStart()"
    >
      <div class="back-card">
        <div class="action-row">
          <button
            class="btn btn-text skip-btn"
            type="button"
            (click)="onBackActionClick($event); isUnsubscribed(stop) ? resubscribeStop(stop) : (isSkipped(stop) ? unskipStop(stop) : skipStop(stop))"
          >
            {{ isUnsubscribed(stop) ? 'Resubscribe' : (isSkipped(stop) ? 'Unskip' : 'Skip') }}
          </button>
          <button class="btn btn-text" type="button" (click)="onBackActionClick($event); openEdit(stop)">Edit</button>
          <button class="btn btn-text reset-warn" type="button" (click)="onBackActionClick($event); resetStop(stop)">Reset</button>
        </div>
        <div class="action-row">
          <button class="btn btn-secondary" type="button" (click)="onBackActionClick($event); openDonationDetails(stop)">Donation</button>
          <button class="btn btn-secondary" type="button" (click)="onBackActionClick($event); openOffScheduleDelivery(stop)">Delivery</button>
        </div>
      </div>

      <div
        class="front-card route-item planner-row-content"
        [style.transform]="getRowTransform(stop)"
        (pointerdown)="startSwipe($event, stop)"
        (pointermove)="moveSwipe($event, stop)"
        (pointerup)="endSwipe($event, stop)"
        (click)="toggleRow(stop)"
      >
        <ng-container *ngIf="reorderEnabled; else orderOnly">
          <div class="drag-handle" cdkDragHandle aria-label="Reorder stop">
            <span class="glyph">‚â°</span>
            <span class="order-number text-muted">
              {{ stop.deliveryOrder + 1 }}
            </span>
          </div>
        </ng-container>
        <ng-template #orderOnly>
          <div class="drag-handle order-only">
            <span class="order-number text-muted">
              {{ stop.deliveryOrder + 1 }}
            </span>
          </div>
        </ng-template>
        <div class="route-item-body">
          <div class="row-top">
            <div class="stop-name">{{ stop.name }}</div>
            <div class="stop-meta">
              <span
                class="status-pill"
                [class.pending]="!stop.status"
                [class.delivered]="stop.status === 'delivered'"
                [class.skipped]="stop.status === 'skipped'"
                [class.changed]="stop.status === 'changed'"
                [class.unsubscribed]="isUnsubscribed(stop)"
              >
                {{ isUnsubscribed(stop) ? 'Unsubscribed' : (stop.status ? (stop.status | titlecase) : 'Pending') }}
              </span>
            </div>
          </div>
          <div class="row-bottom">
            <div class="stop-address text-muted">
              {{ stop.address || '(no address)' }}
              <br />
              {{ stop.city }}<span *ngIf="stop.city && stop.state">,</span> {{ stop.state }} {{ stop.zip }}
            </div>
            <div class="stop-qty">
              <button type="button" class="qty-btn" (click)="adjustPlanned(stop, -1); $event.stopPropagation()">‚àí</button>
              <span class="qty-display" aria-label="Planned dozen">{{ stop.dozens }}</span>
              <button type="button" class="qty-btn" (click)="adjustPlanned(stop, 1); $event.stopPropagation()">+</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Inline edit card shown beneath the stop being edited -->
      <div class="edit-inline card" *ngIf="editingStop?.id === stop.id">
        <h3>Edit delivery</h3>
        <div class="new-form">
          <label>
            Schedule
            <select
              class="form-control"
              [(ngModel)]="editDraft.routeDate"
              name="editRouteDate"
            >
              <option *ngFor="let r of routes" [ngValue]="r.routeDate">
                {{ r.routeDate }}
              </option>
            </select>
          </label>
          <label>
            Name
            <input class="form-control" [(ngModel)]="editDraft.name" name="editName" />
          </label>
          <label>
            Address
            <input class="form-control" [(ngModel)]="editDraft.address" name="editAddress" />
          </label>
          <label>
            City
            <input class="form-control" [(ngModel)]="editDraft.city" name="editCity" />
          </label>
          <label>
            State
            <input class="form-control" [(ngModel)]="editDraft.state" name="editState" />
          </label>
          <label>
            ZIP
            <input class="form-control" [(ngModel)]="editDraft.zip" name="editZip" />
          </label>
          <label>
            Order in route
            <input
              class="form-control"
              type="number"
              min="1"
              [max]="deliveries.length"
              [(ngModel)]="editDraft.deliveryOrder"
              name="editOrder"
            />
          </label>
          <label>
            Dozen
            <input
              class="form-control"
              type="number"
              min="0"
              [(ngModel)]="editDraft.dozens"
              name="editDozens"
            />
          </label>
          <label class="full-width">
            Notes
            <textarea class="form-control" rows="2" [(ngModel)]="editDraft.notes" name="editNotes"></textarea>
          </label>
        </div>
        <div class="donation-actions">
          <div class="left-actions">
            <button
              *ngIf="editingStop && isUnsubscribed(editingStop)"
              class="btn btn-secondary"
              type="button"
              (click)="resubscribeStop(editingStop)"
            >
              Resubscribe
            </button>
            <button
              *ngIf="editingStop && !isUnsubscribed(editingStop)"
              class="btn btn-text warn"
              type="button"
              (click)="unsubscribeStop(editingStop)"
            >
              Unsubscribe
            </button>
          </div>
          <div class="right-actions">
            <button class="btn btn-text" type="button" (click)="cancelEdit()">Cancel</button>
            <button class="btn btn-primary" type="button" (click)="saveEdit()">Save</button>
          </div>
        </div>
      </div>

      <!-- Inline donation card beneath this stop -->
      <div class="inline-donation card" *ngIf="donationModalStop?.id === stop.id">
        <h3 class="one-off-title">One-Time Donation</h3>
        <div class="inline-donation-body">
          <div class="card donation-card">
            <app-donation-controls
              [donation]="donationDraft?.donation || null"
              [suggestedAmount]="donationDraft?.donation?.suggestedAmount || (donationModalStop?.dozens ?? 0) * getSuggestedRate()"
              [showNoDonation]="true"
              [allowReselect]="true"
              [showQty]="false"
              (donationStatusChange)="setDonationStatus($event)"
              (donationMethodChange)="setDonationMethod($event)"
              (amountChange)="onDonationAmountChange($event)"
            />
            <label class="date-field">
              Donation date
              <input
                class="form-control"
                type="date"
                [min]="oneOffDateMin"
                [max]="oneOffDateMax"
                [ngModel]="oneOffDonationDate"
                (ngModelChange)="onOneOffDonationDateChange($event)"
                name="oneOffDonationDate"
                required
                [attr.aria-invalid]="oneOffDonationDateError ? 'true' : null"
                [attr.aria-describedby]="oneOffDonationDateError ? 'one-off-donation-date-error' : null"
              />
            </label>
            @if (oneOffDonationDateError) {
              <p class="error-text" id="one-off-donation-date-error">
                {{ oneOffDonationDateError }}
              </p>
            }
          </div>
          @if (oneOffDonationTypeError) {
            <p class="error-text">{{ oneOffDonationTypeError }}</p>
          }
          <div class="donation-actions">
            <button type="button" class="btn btn-text" (click)="closeDonationModal(true)">Cancel</button>
            <button
              type="button"
              class="btn btn-primary"
              [disabled]="!!oneOffDonationDateError || !!oneOffDonationTypeError"
              (click)="saveDonation()"
            >
              Save
            </button>
          </div>
          <div class="card totals-card">
            <div class="totals-row">
              <span>Total Donations</span>
              <span>${{ donationTotals.donationTotal | number : '1.2-2' }}</span>
            </div>
            <div class="totals-row">
              <span>Total Dozen</span>
              <span>{{ donationTotals.dozensTotal }}</span>
            </div>
            <div class="totals-row">
              <span>Baseline value</span>
              <span>${{ donationTotals.baselineTotal | number : '1.2-2' }}</span>
            </div>
            <div class="totals-row">
              <span>Deductible charitable contribution</span>
              <span>${{ donationTotals.taxableTotal | number : '1.2-2' }}</span>
            </div>
            <ng-container [ngTemplateOutlet]="receiptHistoryList"></ng-container>
          </div>
        </div>
      </div>

      <!-- Inline off-schedule delivery card beneath this stop -->
      <div class="inline-donation card" *ngIf="offScheduleStop?.id === stop.id">
        <h3 class="one-off-title">One-Time Delivery</h3>
        <div class="inline-donation-body">
          <div class="delivery-card card">
            <app-stop-delivery-card
              [stop]="offScheduleStop"
              [deliveredQty]="offDeliveredQty"
              [donation]="offDonationDraft"
              [suggestedAmount]="offDonationDraft?.suggestedAmount ?? offDeliveredQty * 4"
              [showNoDonation]="true"
              [allowDonationReselect]="false"
              [showNotes]="false"
              [showHeaderInfo]="false"
              [showStatusPill]="false"
              [showAddressText]="false"
              (adjustQty)="adjustOffDelivered($event)"
              (donationStatusChange)="setOffDonationStatus($event)"
              (donationMethodChange)="setOffDonationMethod($event)"
              (amountChange)="onOffAmountChange($event)"
              (copyAddress)="copyAddress(offScheduleStop)"
              (openMap)="openMaps(offScheduleStop)"
            />
            <label class="date-field">
              Delivery date
              <input
                class="form-control"
                type="date"
                [min]="oneOffDateMin"
                [max]="oneOffDateMax"
                [ngModel]="oneOffDeliveryDate"
                (ngModelChange)="onOneOffDeliveryDateChange($event)"
                name="oneOffDeliveryDate"
                required
                [attr.aria-invalid]="oneOffDeliveryDateError ? 'true' : null"
                [attr.aria-describedby]="oneOffDeliveryDateError ? 'one-off-delivery-date-error' : null"
              />
            </label>
            @if (oneOffDeliveryDateError) {
              <p class="error-text" id="one-off-delivery-date-error">
                {{ oneOffDeliveryDateError }}
              </p>
            }
          </div>
          @if (oneOffDeliveryTypeError) {
            <p class="error-text">{{ oneOffDeliveryTypeError }}</p>
          }
          <div class="donation-actions">
            <button type="button" class="btn btn-text" (click)="closeOffSchedule(true)">Cancel</button>
            <button
              type="button"
              class="btn btn-primary"
              [disabled]="!!oneOffDeliveryDateError || !!oneOffDeliveryTypeError"
              (click)="saveOffSchedule()"
            >
              Save
            </button>
          </div>
          <div class="card totals-card">
            <div class="totals-row">
              <span>Total Donations</span>
              <span>${{ donationTotals.donationTotal | number : '1.2-2' }}</span>
            </div>
            <div class="totals-row">
              <span>Total Dozen</span>
              <span>{{ donationTotals.dozensTotal }}</span>
            </div>
            <div class="totals-row">
              <span>Baseline value</span>
              <span>${{ donationTotals.baselineTotal | number : '1.2-2' }}</span>
            </div>
            <div class="totals-row">
              <span>Deductible charitable contribution</span>
              <span>${{ donationTotals.taxableTotal | number : '1.2-2' }}</span>
            </div>
            <ng-container [ngTemplateOutlet]="receiptHistoryList"></ng-container>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!loading && !errorMessage && viewingRun">
  <div class="run-history-header text-muted" *ngIf="viewingAllReceipts">
    All receipts ¬∑ Tax year {{ selectedTaxYearLabel }}
  </div>
  <div class="drop-list">
    <div
      class="planner-swipe-row"
      *ngFor="let entry of filteredRunEntries"
    >
      <div class="route-item run-history-card">
        <div class="drag-handle order-only">
          <span class="order-number text-muted" *ngIf="!viewingAllReceipts">
            {{ entry.deliveryOrder + 1 }}
          </span>
        </div>
        <div class="route-item-body">
        <div class="row-top">
          <div class="stop-name">
            {{ entry.name }}
          </div>
          <div class="stop-meta">
            <span
              class="status-pill"
              [class.delivered]="entry.status === 'delivered'"
              [class.skipped]="entry.status === 'skipped'"
              [class.donation]="entry.status === 'donation'"
            >
              {{ entry.status | titlecase }}
            </span>
          </div>
        </div>
        <div class="row-bottom">
          <div class="donation-summary text-muted">
            <ng-container *ngIf="entry.status !== 'donation'; else donationOnly">
              {{ entry.dozens }} dozen
              &nbsp;‚Äì&nbsp;
              <ng-container [ngSwitch]="entry.donationStatus">
                <span *ngSwitchCase="'NoDonation'">No donation</span>
                <span *ngSwitchCase="'NotRecorded'">Donation not recorded</span>
                <span *ngSwitchCase="'Donated'">
                  {{ entry.donationMethod ? (entry.donationMethod | titlecase) : 'Donated' }}
                  ${{ entry.donationAmount | number : '1.2-2' }}
                </span>
              </ng-container>
            </ng-container>
            <ng-template #donationOnly>
              <ng-container [ngSwitch]="entry.donationStatus">
                <span *ngSwitchCase="'NoDonation'">No donation</span>
                <span *ngSwitchCase="'NotRecorded'">Donation not recorded</span>
                <span *ngSwitchCase="'Donated'">
                  {{ entry.donationMethod ? (entry.donationMethod | titlecase) : 'Donated' }}
                  ${{ entry.donationAmount | number : '1.2-2' }}
                </span>
              </ng-container>
            </ng-template>
          </div>
        </div>
          <div class="run-entry-meta">
            <div class="entry-date text-muted">
              <ng-container *ngIf="entry.eventDate; else noDate">
                {{ entry.eventDate | date : 'short' : undefined : 'en-US' }}
              </ng-container>
            </div>
            <div class="run-entry-actions">
              <button
                type="button"
                class="btn btn-text btn-inline"
                (click)="openRunEntryEdit(entry)"
              >
                Edit
              </button>
              @if (canDeleteRunEntry(entry)) {
                <button
                  type="button"
                  class="btn btn-text btn-inline warn"
                  (click)="confirmDeleteRunEntry(entry)"
                  [attr.aria-label]="getRunEntryDeleteLabel(entry)"
                >
                  Delete
                </button>
              }
            </div>
          </div>
          <ng-template #noDate>
            <span class="entry-date-missing">(no date)</span>
          </ng-template>
        </div>
      </div>

      <!-- Inline edit card for receipts (All receipts / runs view) -->
      <div
        class="inline-donation card"
        *ngIf="editingRunEntry?.id === entry.id && runEntryDraft"
      >
        <h3>Edit receipt</h3>
        <div class="inline-donation-body">
          <div class="card">
            <div class="new-form">
              @if (editingRunEntry?.runId === 'oneoff') {
                <label class="date-field">
                  {{ editingRunEntry?.oneOffKind === 'donation' ? 'Donation date' : 'Delivery date' }}
                  <input
                    class="form-control"
                    type="date"
                    [min]="oneOffDateMin"
                    [max]="oneOffDateMax"
                    [ngModel]="runEntryDate"
                    (ngModelChange)="onRunEntryDateChange($event)"
                    name="runEntryDate"
                    required
                    [attr.aria-invalid]="runEntryDateError ? 'true' : null"
                    [attr.aria-describedby]="runEntryDateError ? 'run-entry-date-error' : null"
                  />
                </label>
                @if (runEntryDateError) {
                  <p class="error-text" id="run-entry-date-error">
                    {{ runEntryDateError }}
                  </p>
                }
              }
              <label *ngIf="editingRunEntry?.runId !== 'oneoff'">
                Status
                <select
                  class="form-control"
                  [(ngModel)]="runEntryDraft.status"
                  name="runEntryStatus"
                >
                  <option value="delivered">Delivered</option>
                  <option value="skipped">Skipped</option>
                </select>
              </label>
              <label *ngIf="editingRunEntry?.runId !== 'oneoff'">
                Order in route
                <input
                  class="form-control"
                  type="number"
                  min="1"
                  [max]="runEntries.length"
                  [(ngModel)]="runEntryDraft.deliveryOrder"
                  name="runEntryOrder"
                />
              </label>
              <label *ngIf="editingRunEntry?.runId !== 'oneoff' || editingRunEntry?.oneOffKind === 'delivery'">
                Dozen
                <input
                  class="form-control"
                  type="number"
                  min="0"
                  [(ngModel)]="runEntryDraft.dozens"
                  name="runEntryDozens"
                />
              </label>
              <label
                *ngIf="
                  editingRunEntry?.runId === 'oneoff' &&
                  runEntryDraft.donationStatus === 'Donated'
                "
              >
                Suggested amount (baseline)
                <input
                  class="form-control"
                  type="number"
                  inputmode="decimal"
                  min="0"
                  max="9999"
                  step="0.01"
                  [ngModel]="runEntryDraft.suggestedAmount"
                  (ngModelChange)="onRunEntrySuggestedAmountChange($event)"
                  name="runEntrySuggested"
                  [attr.aria-invalid]="runEntrySuggestedError ? 'true' : null"
                  [attr.aria-describedby]="runEntrySuggestedError ? 'run-entry-suggested-error' : null"
                />
                @if (runEntrySuggestedError) {
                  <p class="error-text" id="run-entry-suggested-error">
                    {{ runEntrySuggestedError }}
                  </p>
                }
              </label>
              <label>
                Donation status
                <select
                  class="form-control"
                  [ngModel]="runEntryDraft.donationStatus"
                  (ngModelChange)="onRunEntryDonationStatusChange($event)"
                  name="runEntryDonationStatus"
                >
                  <option value="NoDonation">No donation</option>
                  <option value="Donated">Donated</option>
                </select>
              </label>
              <label *ngIf="runEntryDraft.donationStatus === 'Donated'">
                Donation method
                <select
                  class="form-control"
                  [(ngModel)]="runEntryDraft.donationMethod"
                  name="runEntryDonationMethod"
                >
                  <option value="">(none)</option>
                  <option value="cash">Cash</option>
                  <option value="ach">Ach</option>
                  <option value="venmo">Venmo</option>
                  <option value="paypal">Paypal</option>
                  <option value="other">Other</option>
                </select>
              </label>
              <label *ngIf="runEntryDraft.donationStatus === 'Donated'">
                Donation amount
                <input
                  class="form-control"
                  type="number"
                  inputmode="decimal"
                  min="0"
                  max="9999"
                  step="0.01"
                  [ngModel]="runEntryDraft.donationAmount"
                  (ngModelChange)="onRunEntryDonationAmountChange($event)"
                  name="runEntryDonationAmount"
                  [attr.aria-invalid]="runEntryAmountError ? 'true' : null"
                  [attr.aria-describedby]="runEntryAmountError ? 'run-entry-amount-error' : null"
                />
                @if (runEntryAmountError) {
                  <p class="error-text" id="run-entry-amount-error">
                    {{ runEntryAmountError }}
                  </p>
                }
              </label>
            </div>
            <div class="donation-actions">
              <button
                class="btn btn-text"
                type="button"
                (click)="cancelRunEntryEdit()"
              >
                Cancel
              </button>
              <button
                class="btn btn-primary"
                type="button"
                [disabled]="
                  (editingRunEntry?.runId === 'oneoff' && !!runEntryDateError) ||
                  !!runEntryAmountError ||
                  !!runEntrySuggestedError
                "
                (click)="saveRunEntryEdit()"
              >
                Save
              </button>
            </div>
          </div>
        </div>
      </div>
  </div>
</div>
<div
  class="status text-muted card"
  *ngIf="!loading && !errorMessage && !viewingRun && !deliveries.length"
>
  No deliveries found for this route.
</div>

<!-- Full-screen overlays removed; donation and delivery edit now inline per stop -->

<div class="amount-overlay" *ngIf="showAmountPicker">
  <app-donation-amount-picker
    [currentAmount]="selectedAmount"
    [suggestedAmount]="donationDraft?.donation?.suggestedAmount ?? 0"
    (cancel)="closeAmountPicker()"
    (save)="confirmAmountFromPicker($event)"
  />
</div>
