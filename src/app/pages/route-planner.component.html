<div class="page-header" [class.searching]="showSearch">
  <div class="header-actions">
    <select
      class="form-control route-select"
      [(ngModel)]="routeDate"
      (ngModelChange)="onRouteChange($event)"
    >
      <option [ngValue]="null" disabled>Choose a route‚Ä¶</option>
      <option [ngValue]="ALL_SCHEDULES">All Schedules ({{ routes.length }})</option>
      <option *ngFor="let r of routes" [ngValue]="r.routeDate">
        {{ r.routeDate }} ({{ r.totalStops }} stops)
      </option>
    </select>
    <button
      class="btn btn-secondary icon-btn btn-reset"
      type="button"
      (click)="resetRoute()"
      [disabled]="!deliveries.length"
      aria-label="Reset route"
      title="Reset route"
    >
      <span class="glyph">‚ü≥</span>
    </button>
    <button
      class="btn btn-primary icon-btn"
      type="button"
      (click)="openNewDeliveryForm()"
      aria-label="Add delivery"
      title="Add delivery"
    >
      <span class="glyph">+</span>
    </button>
    <button
      class="btn btn-secondary icon-btn btn-search"
      type="button"
      (click)="toggleSearch()"
      aria-label="Search deliveries"
      title="Search deliveries"
    >
      <span class="glyph">üîç</span>
    </button>
  </div>
  <div class="search-row" *ngIf="showSearch">
    <input
      class="form-control search-input"
      type="search"
      placeholder="Search deliveries‚Ä¶"
      [(ngModel)]="searchTerm"
      (ngModelChange)="applyFilter()"
    />
    <button
      class="btn btn-secondary icon-btn"
      type="button"
      (click)="searchTerm=''; applyFilter(false); toggleSearch()"
      aria-label="Close search"
      title="Close search"
    >
      √ó
    </button>
  </div>
</div>

<div *ngIf="loading" class="status text-muted">Loading‚Ä¶</div>
<div *ngIf="errorMessage" class="status error">{{ errorMessage }}</div>

<div class="card new-delivery-card" *ngIf="showNewForm">
  <div class="new-header">
    <h3 class="section-title">Add delivery</h3>
    <div class="new-actions">
      <button class="btn btn-text" type="button" (click)="cancelNewDelivery()">Cancel</button>
      <button class="btn btn-primary" type="button" (click)="saveNewDelivery()" [disabled]="!canSaveNew || savingNew">
        {{ savingNew ? 'Saving‚Ä¶' : 'Save' }}
      </button>
    </div>
  </div>

  <form class="new-form" (submit)="$event.preventDefault()">
    <label>
      Schedule
      <select
        class="form-control"
        [(ngModel)]="newDelivery.routeDate"
        name="newRouteDate"
      >
        <option *ngFor="let r of routes" [ngValue]="r.routeDate">
          {{ r.routeDate }}
        </option>
      </select>
    </label>
    <label>
      Name
      <input class="form-control" [(ngModel)]="newDelivery.name" name="newName" />
    </label>
    <label>
      Address
      <input class="form-control" [(ngModel)]="newDelivery.address" name="newAddress" />
    </label>
    <label>
      City
      <input class="form-control" [(ngModel)]="newDelivery.city" name="newCity" />
    </label>
    <label>
      State
      <input class="form-control" [(ngModel)]="newDelivery.state" name="newState" />
    </label>
    <label>
      ZIP
      <input class="form-control" [(ngModel)]="newDelivery.zip" name="newZip" />
    </label>
    <label>
      Dozens
      <input
        class="form-control"
        type="number"
        min="0"
        [(ngModel)]="newDelivery.dozens"
        name="newDozens"
        required
      />
    </label>
    <label class="full-width">
      Notes
      <textarea class="form-control" rows="2" [(ngModel)]="newDelivery.notes" name="newNotes"></textarea>
    </label>
    <div class="form-hint full-width" *ngIf="newDeliveryErrors.length">
      <div *ngFor="let err of newDeliveryErrors" class="error-text">{{ err }}</div>
    </div>
    <div class="form-hint full-width text-muted">
      Address fields can be left blank if unknown. You can reorder or edit later.
    </div>
  </form>
</div>

<div class="list card" *ngIf="!loading && !errorMessage && deliveries.length">
  <div
    cdkDropList
    [cdkDropListData]="filteredDeliveries"
    [cdkDropListDisabled]="(showSearch && searchTerm.trim()) || routeDate === ALL_SCHEDULES"
    (cdkDropListDropped)="drop($event)"
    class="drop-list"
  >
    <div
      class="planner-swipe-row"
      *ngFor="let stop of filteredDeliveries; let i = index"
      cdkDrag
      [class.open]="openRowId === stop.id"
      [cdkDragDisabled]="isSwiping"
      (cdkDragStarted)="handleDragStart()"
    >
      <div class="planner-swipe-actions">
        <div class="action-row">
          <button
            class="btn btn-text skip-btn"
            type="button"
            (click)="isSkipped(stop) ? unskipStop(stop) : skipStop(stop)"
          >
            {{ isSkipped(stop) ? 'Unskip' : 'Skip' }}
          </button>
          <button class="btn btn-text" type="button" (click)="openEdit(stop)">Edit</button>
          <button class="btn btn-text reset-warn" type="button" (click)="resetStop(stop)" [disabled]="!stop.status">Reset</button>
        </div>
        <div class="action-row">
          <button class="btn btn-secondary" type="button" (click)="openDonationDetails(stop)">Donation</button>
          <button class="btn btn-secondary" type="button" (click)="openOffScheduleDelivery(stop)">Delivery</button>
        </div>
      </div>

      <div class="route-item planner-row-content"
        [style.transform]="getRowTransform(stop)"
        (pointerdown)="startSwipe($event, stop)"
        (pointermove)="moveSwipe($event, stop)"
        (pointerup)="endSwipe($event, stop)"
        (click)="toggleRow(stop)">
        <div class="drag-handle" cdkDragHandle aria-label="Reorder stop">‚â°</div>
        <div class="route-item-body two-col">
          <div class="col-left">
            <div class="stop-name">{{ stop.name }}</div>
            <div class="stop-address text-muted">
              {{ stop.address || '(no address)' }}
              <br />
              {{ stop.city }}<span *ngIf="stop.city && stop.state">,</span> {{ stop.state }} {{ stop.zip }}
            </div>
          </div>
          <div class="col-right">
            <div class="stop-meta">
              <span class="status-pill" [class.pending]="!stop.status" [class.unsubscribed]="isUnsubscribed(stop)">
                {{ isUnsubscribed(stop) ? 'Unsubscribed' : (stop.status ? (stop.status | titlecase) : 'Pending') }}
              </span>
            </div>
            <div class="stop-qty">
              <button type="button" class="qty-btn" (click)="adjustPlanned(stop, -1); $event.stopPropagation()">‚àí</button>
              <span class="qty-display" aria-label="Planned dozens">{{ stop.dozens }}</span>
              <button type="button" class="qty-btn" (click)="adjustPlanned(stop, 1); $event.stopPropagation()">+</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="status text-muted card" *ngIf="!loading && !errorMessage && !deliveries.length">
  No deliveries found for this route.
</div>

<div class="donation-overlay" *ngIf="donationModalStop">
  <div class="donation-dialog">
    <h3>Donation for {{ donationModalStop!.name }}</h3>
    <p class="text-muted">
      Suggested: ${{ donationModalStop!.dozens * 4 }} ({{ donationModalStop!.dozens }} dz &#64; $4/dozen)
    </p>
    <div class="donation-toggle">
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.status === 'NotRecorded'"
        (click)="setDonationStatus('NotRecorded')"
      >
        Not recorded
      </button>
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.status === 'Donated'"
        (click)="setDonationStatus('Donated')"
      >
        Donated
      </button>
    </div>

    <div *ngIf="donationDraft?.donation?.status === 'Donated'" class="donation-methods">
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.method === 'cash'"
        (click)="setDonationMethod('cash')"
      >
        Cash
      </button>
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.method === 'venmo'"
        (click)="setDonationMethod('venmo')"
      >
        Venmo
      </button>
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.method === 'ach'"
        (click)="setDonationMethod('ach')"
      >
        ACH
      </button>
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.method === 'paypal'"
        (click)="setDonationMethod('paypal')"
      >
        PayPal
      </button>
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.method === 'other'"
        (click)="setDonationMethod('other')"
      >
        Other
      </button>
    </div>

    <div class="donation-amount-row" *ngIf="donationDraft?.donation?.status === 'Donated'">
      <span>Amount: ${{ donationDraft?.donation?.amount ?? donationDraft?.donation?.suggestedAmount }}</span>
      <button type="button" class="btn-link" (click)="openAmountPicker()">Adjust amount</button>
    </div>

    <div class="donation-actions">
      <button type="button" class="ghost" (click)="closeDonationModal()">Cancel</button>
      <button type="button" (click)="saveDonation()">Save</button>
    </div>
  </div>
</div>

<div class="donation-overlay" *ngIf="offScheduleStop">
  <div class="donation-dialog">
    <h3>Delivery for {{ offScheduleStop!.name }}</h3>
    <div class="delivery-card card">
      <app-stop-delivery-card
        [stop]="offScheduleStop"
        [deliveredQty]="offDeliveredQty"
        [donation]="offDonationDraft"
        [suggestedAmount]="offDonationDraft?.suggestedAmount ?? offDeliveredQty * 4"
        [showNoDonation]="true"
        [showNotes]="false"
        (adjustQty)="adjustOffDelivered($event)"
        (donationStatusChange)="setOffDonationStatus($event)"
        (donationMethodChange)="setOffDonationMethod($event)"
        (amountChange)="onOffAmountChange($event)"
        (copyAddress)="copyAddress(offScheduleStop)"
        (openMap)="openMaps(offScheduleStop)"
      />
    </div>
    <div class="donation-actions">
      <button type="button" class="ghost" (click)="closeOffSchedule()">Cancel</button>
      <button type="button" class="btn btn-primary" (click)="saveOffSchedule()">Save</button>
    </div>
  </div>
</div>

<div class="edit-overlay" *ngIf="editingStop">
  <div class="donation-dialog">
    <h3>Edit delivery</h3>
    <div class="new-form">
      <label>
        Schedule
        <select
          class="form-control"
          [(ngModel)]="editDraft.routeDate"
          name="editRouteDate"
        >
          <option *ngFor="let r of routes" [ngValue]="r.routeDate">
            {{ r.routeDate }}
          </option>
        </select>
      </label>
      <label>
        Name
        <input class="form-control" [(ngModel)]="editDraft.name" name="editName" />
      </label>
      <label>
        Address
        <input class="form-control" [(ngModel)]="editDraft.address" name="editAddress" />
      </label>
      <label>
        City
        <input class="form-control" [(ngModel)]="editDraft.city" name="editCity" />
      </label>
      <label>
        State
        <input class="form-control" [(ngModel)]="editDraft.state" name="editState" />
      </label>
      <label>
        ZIP
        <input class="form-control" [(ngModel)]="editDraft.zip" name="editZip" />
      </label>
      <label>
        Dozens
        <input
          class="form-control"
          type="number"
          min="0"
          [(ngModel)]="editDraft.dozens"
          name="editDozens"
        />
      </label>
      <label class="full-width">
        Notes
        <textarea class="form-control" rows="2" [(ngModel)]="editDraft.notes" name="editNotes"></textarea>
      </label>
    </div>
    <div class="donation-actions">
      <div class="left-actions">
        <button
          *ngIf="editingStop && isUnsubscribed(editingStop)"
          class="btn btn-secondary"
          type="button"
          (click)="resubscribeStop(editingStop)"
        >
          Resubscribe
        </button>
        <button
          *ngIf="editingStop && !isUnsubscribed(editingStop)"
          class="btn btn-text warn"
          type="button"
          (click)="unsubscribeStop(editingStop)"
        >
          Unsubscribe
        </button>
      </div>
      <div class="right-actions">
        <button class="btn btn-text" type="button" (click)="cancelEdit()">Cancel</button>
        <button class="btn btn-primary" type="button" (click)="saveEdit()">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="amount-overlay" *ngIf="showAmountPicker">
  <app-donation-amount-picker
    [currentAmount]="selectedAmount"
    [suggestedAmount]="donationDraft?.donation?.suggestedAmount ?? 0"
    (cancel)="closeAmountPicker()"
    (save)="confirmAmountFromPicker($event)"
  />
</div>
