<div class="page-header">
  <div>
    <h1 class="section-title">Route Planner</h1>
    <div class="sub text-muted" *ngIf="routeDate">Route: {{ routeDate }}</div>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary" type="button" (click)="resetRoute()" [disabled]="!deliveries.length">
      Reset route
    </button>
    <button class="btn btn-primary" type="button" (click)="startRun()" [disabled]="!deliveries.length">
      Start Run
    </button>
  </div>
</div>

<div *ngIf="loading" class="status text-muted">Loading…</div>
<div *ngIf="errorMessage" class="status error">{{ errorMessage }}</div>

<div class="list card" *ngIf="!loading && !errorMessage && deliveries.length; else empty">
  <div
    cdkDropList
    [cdkDropListData]="deliveries"
    (cdkDropListDropped)="drop($event)"
    class="drop-list"
  >
    <div
      class="planner-swipe-row"
      *ngFor="let stop of deliveries; let i = index"
      cdkDrag
      [class.open]="openRowId === stop.id"
      [cdkDragDisabled]="isSwiping"
      (cdkDragStarted)="handleDragStart()"
    >
      <div class="planner-swipe-actions">
        <button class="btn btn-secondary pill-btn" type="button" (click)="openDonationDetails(stop)">
          <span [ngClass]="getDonationPillClass(stop)">{{ getDonationPillLabel(stop) }}</span>
        </button>
        <button class="btn btn-text" type="button" (click)="resetStop(stop)" [disabled]="!stop.status">Reset</button>
        <button class="btn btn-text warn" type="button" (click)="skipStop(stop)">Skip</button>
      </div>

      <div
        class="route-item planner-row-content"
        [style.transform]="getRowTransform(stop)"
        (pointerdown)="startSwipe($event, stop)"
        (pointermove)="moveSwipe($event, stop)"
        (pointerup)="endSwipe($event, stop)"
        (click)="toggleRow(stop)"
      >
        <div class="drag-handle" cdkDragHandle aria-label="Reorder stop">≡</div>
        <div class="route-item-body">
          <div class="item-top">
            <div class="stop-info">
              <div class="stop-name">{{ stop.name }}</div>
              <div class="stop-city text-muted">{{ stop.city }}, {{ stop.state }}</div>
            </div>
            <div class="stop-qty">
              <button type="button" class="qty-btn" (click)="adjustPlanned(stop, -1); $event.stopPropagation()">−</button>
              <span class="qty-display" aria-label="Planned dozens">{{ stop.dozens }}</span>
              <button type="button" class="qty-btn" (click)="adjustPlanned(stop, 1); $event.stopPropagation()">+</button>
              <span class="qty-unit text-muted">dz</span>
            </div>
          </div>
          <div class="item-bottom">
            <span class="status-pill" *ngIf="stop.status">{{ stop.status | titlecase }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #empty>
  <div class="status text-muted card">No deliveries found for this route.</div>
</ng-template>

<div class="donation-overlay" *ngIf="donationModalStop">
  <div class="donation-dialog">
    <h3>Donation for {{ donationModalStop!.name }}</h3>
    <p class="text-muted">
      Suggested: ${{ donationModalStop!.dozens * 4 }} ({{ donationModalStop!.dozens }} dz &#64; $4/dozen)
    </p>
    <div class="donation-toggle">
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.status === 'NotRecorded'"
        (click)="setDonationStatus('NotRecorded')"
      >
        Not recorded
      </button>
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.status === 'Donated'"
        (click)="setDonationStatus('Donated')"
      >
        Donated
      </button>
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.status === 'NoDonation'"
        (click)="setDonationStatus('NoDonation')"
      >
        No donation
      </button>
    </div>

    <div *ngIf="donationDraft?.donation?.status === 'Donated'" class="donation-methods">
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.method === 'cash'"
        (click)="setDonationMethod('cash')"
      >
        Cash
      </button>
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.method === 'venmo'"
        (click)="setDonationMethod('venmo')"
      >
        Venmo
      </button>
      <button
        type="button"
        class="btn-chip"
        [class.active]="donationDraft?.donation?.method === 'other'"
        (click)="setDonationMethod('other')"
      >
        Other
      </button>
    </div>

    <div class="donation-amount-row" *ngIf="donationDraft?.donation?.status === 'Donated'">
      <span>Amount: ${{ donationDraft?.donation?.amount ?? donationDraft?.donation?.suggestedAmount }}</span>
      <button type="button" class="btn-link" (click)="openAmountPicker()">Adjust amount</button>
    </div>

    <div class="donation-actions">
      <button type="button" class="ghost" (click)="closeDonationModal()">Cancel</button>
      <button type="button" (click)="saveDonation()">Save</button>
    </div>
  </div>
</div>

<div class="amount-overlay" *ngIf="showAmountPicker">
  <app-donation-amount-picker
    [currentAmount]="selectedAmount"
    [suggestedAmount]="donationDraft?.donation?.suggestedAmount ?? 0"
    (cancel)="closeAmountPicker()"
    (save)="confirmAmountFromPicker($event)"
  />
</div>
