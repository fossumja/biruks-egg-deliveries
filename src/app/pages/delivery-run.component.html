<div class="run-screen">
  <div class="header">
  </div>

  <div *ngIf="loading" class="status text-muted">Loading…</div>
  <div *ngIf="errorMessage" class="status error">{{ errorMessage }}</div>

  <main *ngIf="!loading && !errorMessage" class="content">
    <div class="delivery-card card" *ngIf="!finished && currentStop" [@cardChange]="currentStop.id ? 'in' : 'void'">
      <div class="card-top">
        <div class="name-row">
          <div class="stop-name">{{ currentStop.name }}</div>
          <span class="status-pill" [class.pending]="!currentStop.status">{{ currentStop.status ? (currentStop.status | titlecase) : 'Pending' }}</span>
        </div>
        <div class="address-row">
          <div class="stop-address text-muted">
            {{ currentStop.address }}<br />
            {{ currentStop.city }}, {{ currentStop.state }} {{ currentStop.zip }}
          </div>
          <div class="address-actions">
            <button class="btn btn-text" type="button" (click)="copyAddress()">Copy</button>
            <button class="btn btn-secondary" type="button" (click)="openMaps()">Open Map</button>
          </div>
        </div>
      </div>

      <div class="stop-qty">
        <div class="qty-label text-muted">Quantity</div>
        <div class="qty-input">
          <button type="button" class="qty-btn" (click)="adjustDelivered(-1)">−</button>
          <span class="qty-display" aria-label="Delivered dozens">{{ deliveredQty }}</span>
          <button type="button" class="qty-btn" (click)="adjustDelivered(1)">+</button>
        </div>
      </div>

      <div class="donation-inline">
        <div class="donation-choices wide">
          <button
            type="button"
            class="btn-chip wide"
            [class.active]="currentDonation.status === 'NoDonation'"
            (click)="setDonationStatus('NoDonation')"
          >
            No donation
          </button>
          <button
            type="button"
            class="btn-chip wide"
            [class.active]="currentDonation.status === 'Donated' && currentDonation.method === 'cash'"
            (click)="setDonationDonated('cash')"
          >
            Cash
          </button>
          <button
            type="button"
            class="btn-chip wide"
            [class.active]="currentDonation.status === 'Donated' && currentDonation.method === 'venmo'"
            (click)="setDonationDonated('venmo')"
          >
            Venmo
          </button>
        </div>
        <div class="donation-suggested text-muted">
          Current: ${{ (currentDonation.amount ?? suggestedDonationAmount) | number: '1.0-0' }}
          · Suggested: ${{ suggestedDonationAmount | number: '1.0-0' }}
          <button type="button" class="btn-link" (click)="openDonationAmountPicker()">Adjust amount</button>
        </div>
      </div>

      <div class="stop-note text-muted" *ngIf="currentStop.notes">
        Note: {{ currentStop.notes }}
      </div>
    </div>

    <div class="next-up card" *ngIf="nextStop">
      <div class="section-title">Next up</div>
      <div class="next-name">{{ nextStop.name }}</div>
      <div class="text-muted">
        {{ nextStop.address }}<br />
        {{ nextStop.city }}, {{ nextStop.state }} {{ nextStop.zip }}
      </div>
      <div class="next-meta text-muted">{{ nextStop.dozens }} dozen{{ nextStop.dozens === 1 ? '' : 's' }}</div>
    </div>
  </main>

  <div class="bottom-bar safe-bottom" *ngIf="!loading && !errorMessage && !finished">
    <button class="btn btn-primary" type="button" (click)="markDelivered()">Deliver</button>
    <button class="btn btn-secondary" type="button" (click)="openSkipDialog()">Skip</button>
  </div>

  <div class="actions-complete" *ngIf="finished && !loading && !errorMessage">
    <button type="button" class="btn btn-primary" (click)="backupNow()">Backup now</button>
    <button class="btn btn-secondary" type="button" (click)="finishRoute()">Done</button>
  </div>
</div>

<div class="amount-overlay" *ngIf="showAmountPicker">
  <app-donation-amount-picker
    [currentAmount]="currentDonation.amount"
    [suggestedAmount]="suggestedDonationAmount"
    (cancel)="closeAmountPicker()"
    (save)="confirmAmountFromPicker($event)"
  />
</div>

<div class="skip-overlay" *ngIf="showSkipDialog">
  <div class="skip-dialog card">
    <h3>Skip reason</h3>
    <div class="reason-buttons">
      <button class="btn btn-secondary" type="button" (click)="confirmSkip('Not home')">Not home</button>
      <button class="btn btn-secondary" type="button" (click)="confirmSkip('Canceled')">Canceled</button>
    </div>
    <div class="custom-reason">
      <input [(ngModel)]="otherReason" placeholder="Other reason" />
      <button class="btn btn-primary" type="button" (click)="confirmSkip(otherReason)">Save</button>
    </div>
    <button class="btn btn-text" type="button" (click)="cancelSkip()">Cancel</button>
  </div>
</div>
