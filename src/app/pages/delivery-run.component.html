<div class="run-screen">
  <div class="header"></div>

  <div *ngIf="loading" class="status text-muted">Loading…</div>
  <div *ngIf="errorMessage" class="status error">{{ errorMessage }}</div>

  <main *ngIf="!loading && !errorMessage" class="content">
    <div
      class="delivery-card card"
      *ngIf="!finished && currentStop"
      [@cardChange]="currentStop.id ? 'in' : 'void'"
    >
      <app-stop-delivery-card
        [stop]="currentStop"
        [deliveredQty]="deliveredQty"
        [donation]="currentDonation"
        [suggestedAmount]="suggestedDonationAmount"
        [showNoDonation]="true"
        [allowDonationReselect]="true"
        (adjustQty)="adjustDelivered($event)"
        (donationStatusChange)="setDonationStatus($event)"
        (donationMethodChange)="setDonationDonated($event)"
        (amountChange)="onInlineAmountChange($event)"
        (copyAddress)="copyAddress()"
        (openMap)="openMaps()"
      />
    </div>

    <div class="next-up card" *ngIf="nextStop">
      <div class="section-title">Next up</div>
      <div class="next-name">{{ nextStop.name }}</div>
      <div class="text-muted">
        {{ nextStop.address }}<br />
        {{ nextStop.city }}, {{ nextStop.state }} {{ nextStop.zip }}
      </div>
      <div class="next-meta text-muted">
        {{ nextStop.dozens }} dozen{{ nextStop.dozens === 1 ? "" : "s" }}
      </div>
    </div>
  </main>

  <div
    class="bottom-bar safe-bottom"
    *ngIf="!loading && !errorMessage && !finished"
  >
    <div class="primary-actions">
      <button class="btn btn-primary" type="button" (click)="markDelivered()">
        Deliver
      </button>
      <button
        class="btn btn-secondary"
        type="button"
        (click)="openSkipDialog()"
      >
        Skip
      </button>
    </div>
    <button
      class="btn btn-secondary btn-end-run"
      type="button"
      (click)="openEndRunDialog()"
    >
      End Run
    </button>
  </div>

  <div class="actions-complete" *ngIf="finished && !loading && !errorMessage">
    <div class="run-summary card" *ngIf="runSummary">
      <div class="summary-header">
        <div>
          <div class="summary-title">Run summary</div>
          <div class="summary-sub text-muted">{{ runSummary.routeLabel }}</div>
        </div>
        <span class="summary-pill" *ngIf="runSummary.endedEarly">
          Ended early
        </span>
      </div>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Completed at</div>
          <div class="summary-value">
            {{ runSummary.completedAt | date:"short" }}
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Total stops</div>
          <div class="summary-value">{{ runSummary.totalStops }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Delivered</div>
          <div class="summary-value">{{ runSummary.delivered }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Skipped</div>
          <div class="summary-value">{{ runSummary.skipped }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Dozens delivered</div>
          <div class="summary-value">{{ runSummary.dozensDelivered }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Total donations</div>
          <div class="summary-value">
            {{ runSummary.donationTotal | currency:"USD":"symbol":"1.2-2" }}
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Taxable total</div>
          <div class="summary-value">
            {{ runSummary.taxableTotal | currency:"USD":"symbol":"1.2-2" }}
          </div>
        </div>
        <div class="summary-item span-2">
          <div class="summary-label">Donation status</div>
          <div class="summary-value">
            Donated {{ runSummary.statusBreakdown.donated }} / No donation
            {{ runSummary.statusBreakdown.noDonation }}
          </div>
        </div>
        <div class="summary-item span-2">
          <div class="summary-label">Donation methods</div>
          <div class="summary-value">
            Cash {{ runSummary.methodBreakdown.cash }} / Online
            {{ runSummary.methodBreakdown.online }} / Other
            {{ runSummary.methodBreakdown.other }}
          </div>
        </div>
      </div>
    </div>
    <div class="completion-actions">
      <button type="button" class="btn btn-primary" (click)="backupNow()">
        Backup now
      </button>
      <button
        type="button"
        class="btn btn-secondary"
        [disabled]="isCompleting"
        (click)="completeRun()"
      >
        {{ isCompleting ? "Completing…" : "Complete run" }}
      </button>
    </div>
  </div>
</div>

<div class="amount-overlay" *ngIf="showAmountPicker">
  <app-donation-amount-picker
    [currentAmount]="currentDonation.amount"
    [suggestedAmount]="suggestedDonationAmount"
    (cancel)="closeAmountPicker()"
    (save)="confirmAmountFromPicker($event)"
  />
</div>

<div class="skip-overlay" *ngIf="showSkipDialog">
  <div class="skip-dialog card">
    <h3>Skip reason</h3>
    <div class="reason-buttons">
      <button
        class="btn btn-secondary"
        type="button"
        (click)="confirmSkip('Not home')"
      >
        Not home
      </button>
      <button
        class="btn btn-secondary"
        type="button"
        (click)="confirmSkip('Canceled')"
      >
        Canceled
      </button>
      <button
        class="btn btn-secondary"
        type="button"
        (click)="confirmSkip('No cooler')"
      >
        No cooler
      </button>
    </div>
    <div class="custom-reason">
      <input [(ngModel)]="otherReason" placeholder="Other reason" />
      <button
        class="btn btn-primary"
        type="button"
        (click)="confirmSkip(otherReason)"
      >
        Save
      </button>
    </div>
    <button class="btn btn-text" type="button" (click)="cancelSkip()">
      Cancel
    </button>
  </div>
</div>

<div class="end-run-overlay" *ngIf="showEndRunDialog">
  <div class="end-run-dialog card">
    <h3>End run early?</h3>
    <p class="text-muted">
      This will mark all remaining stops in this route as
      <strong>Skipped</strong>. You can still edit them later on the Planner
      page if needed.
    </p>
    <div class="end-run-actions">
      <button
        class="btn btn-secondary btn-cancel-large"
        type="button"
        (click)="cancelEndRun()"
      >
        Cancel
      </button>
      <button
        class="btn btn-secondary btn-proceed-small"
        type="button"
        (click)="confirmEndRunEarly()"
      >
        Proceed
      </button>
    </div>
  </div>
</div>
