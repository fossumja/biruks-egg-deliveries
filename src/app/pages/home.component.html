<section class="card hero">
  <div class="actions">
    <button
      type="button"
      class="btn btn-secondary btn-outline-primary"
      (click)="onImportClick(fileInput)"
      [disabled]="isImporting"
    >
      {{ isImporting ? "Importing…" : "Import CSV" }}
    </button>
    <button
      type="button"
      class="btn btn-secondary"
      (click)="exportCsv()"
      [disabled]="isExporting"
    >
      {{ isExporting ? "Preparing…" : "Backup (CSV)" }}
    </button>
    <button
      type="button"
      class="btn btn-secondary"
      (click)="openHelp()"
    >
      Help
    </button>
    <input
      #fileInput
      type="file"
      accept=".csv,text/csv"
      hidden
      (change)="onFileSelected($event)"
    />
  </div>
  <div class="subtext text-muted" *ngIf="lastBackupAt">
    Last backup: {{ lastBackupAt | date : "short" }}
    <span *ngIf="showImportHint">
      — tap “Import CSV” again to choose a file.
    </span>
  </div>
  <div class="subtext text-muted" *ngIf="lastImportAt">
    Imported: {{ lastImportAt | date : "short" }}
  </div>
  <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
</section>

<section class="card settings-card">
  <div class="settings-row">
    <div>
      <div class="settings-title">Dark mode</div>
      <div class="text-muted settings-subtitle">Toggle dark mode.</div>
    </div>
    <button
      type="button"
      class="btn"
      [ngClass]="darkModeEnabled ? 'btn-primary' : 'btn-secondary'"
      (click)="toggleDarkMode()"
      title="Dark mode"
    >
      {{ darkModeEnabled ? "On" : "Off" }}
    </button>
  </div>
</section>

<section class="card settings-card">
  <div class="settings-row">
    <div>
      <div class="settings-title">Keep screen awake</div>
      <div class="text-muted settings-subtitle">
        Prevents the display from sleeping while you use the app.
      </div>
    </div>
    <button
      type="button"
      class="btn"
      [ngClass]="wakeLockActive ? 'btn-primary' : 'btn-secondary'"
      (click)="toggleWakeLock()"
      [disabled]="!wakeLockSupported"
      title="Keep the screen awake while using the app"
    >
      {{ wakeLockActive ? "On" : "Off" }}
    </button>
  </div>
  <div class="text-muted" *ngIf="!wakeLockSupported">
    Screen wake lock is not supported on this device/browser.
  </div>
</section>

<section class="card settings-card">
  <div class="settings-row">
    <div>
      <div class="settings-title">Suggested donation/dozen</div>
      <div class="text-muted settings-subtitle">
        Used across planner and run screens.
      </div>
    </div>
    <div class="qty-picker">
      <button type="button" class="qty-btn" (click)="changeSuggested(-1)">
        −
      </button>
      <span class="qty-display">${{ suggestedRate }}</span>
      <button type="button" class="qty-btn" (click)="changeSuggested(1)">
        +
      </button>
    </div>
  </div>
</section>

<section class="card build-card" *ngIf="buildInfo as info">
  <div class="text-muted small">
    Updated
    {{ info.builtAt | date : "yyyy-MM-dd HH:mm:ss" : undefined : "en-US" }}
    <span *ngIf="info.commit"> (commit {{ info.commit.slice(0, 7) }})</span>
  </div>
</section>

<div class="help-overlay" *ngIf="showHelp">
  <div class="help-dialog card">
    <h3>Biruk’s Egg Deliveries – Help</h3>
    <div class="help-content">
      <p>
        This app helps you import your delivery CSV, plan routes, run deliveries,
        record donations (including the taxable portion), and export a single CSV
        that you can use for records and taxes.
      </p>

      <h4>Daily / Weekly workflow</h4>
      <ul>
        <li>Import your route CSV on the Home page.</li>
        <li>Use <strong>Planner</strong> to review stops, adjust dozens, add/edit people, and manage subscriptions.</li>
        <li>Use <strong>Run</strong> to deliver or skip each stop and record donations.</li>
        <li>When finished, optionally <strong>Backup (CSV)</strong>, then tap <strong>Complete run</strong> on the Run page.</li>
      </ul>

      <h4>Planner</h4>
      <ul>
        <li>Choose a schedule (e.g., Week A) from the dropdown.</li>
        <li>Use the run selector (when present) to switch between <em>Current (live)</em> and past runs.</li>
        <li>Swipe a card to open the hidden menu: Reset, Edit, Skip/Unskip, Unsubscribe/Resubscribe, one‑off Donation, one‑off Delivery.</li>
        <li>Use the Reorder toggle + drag handle to change the order, or turn it off to avoid accidental moves.</li>
      </ul>

      <h4>Run page</h4>
      <ul>
        <li>Deliver or Skip each stop; changes are saved immediately.</li>
        <li>Use the donation buttons to record how much and how people paid.</li>
        <li><strong>End Run</strong> marks all remaining stops as skipped.</li>
        <li><strong>Complete run</strong> archives the run and resets the route so you can run it again later.</li>
      </ul>

      <h4>Exports & totals</h4>
      <ul>
        <li><strong>Backup (CSV)</strong> always contains:</li>
        <li>All original columns from your import.</li>
        <li>All completed runs recorded in the app.</li>
        <li>All one‑off deliveries and donations.</li>
        <li>Running totals per person for dozens, donations, and taxable donations.</li>
      </ul>

      <p class="text-muted">
        You can run many times during the year and export whenever you need.
        For tax time, export a fresh CSV and use its totals to build donor statements.
      </p>
    </div>
    <div class="help-actions">
      <button type="button" class="btn btn-secondary" (click)="closeHelp()">
        Close
      </button>
    </div>
  </div>
</div>
